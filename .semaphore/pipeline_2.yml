version: v1.0
name: DockerHub
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Publish
    task:
      jobs:
        - name: docker tag and push
          commands:
            - echo 'Publishing to DockerHub!'
            - cat gitinfo_docker.env
      secrets:
        - name: dockerhub-secrets
      prologue:
        commands:
          - 'echo "${DOCKERHUB_PASSWORD}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin'
          - artifact pull workflow gitinfo_docker.env
  - name: Readme
    task:
      secrets:
        - name: dockerhub-secrets
      jobs:
        - name: Update Readme
          commands:
            - 'echo "DOCKERHUB_USER=${DOCKER_USERNAME}" > secrets'
            - 'echo "DOCKERHUB_PASS=${DOCKER_PASSWORD}" >> secrets'
            - '#docker run --rm -t -v $(pwd):/myvol --env-file secrets -e PUSHRM_FILE=/myvol/README.md chko/docker-pushrm:1 --debug "${DOCKERHUB_USERNAME}/webvirtmgr-docker"'
      prologue:
        commands:
          - checkout
          - 'echo "${DOCKERHUB_PASSWORD}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin'
